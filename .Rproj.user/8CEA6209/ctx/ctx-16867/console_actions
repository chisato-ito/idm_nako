{
    "type": [
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        3,
        0,
        1,
        3,
        0,
        1,
        3,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        3,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        3,
        0,
        1,
        3,
        0,
        1,
        3,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        3,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2
    ],
    "data": [
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt), na.rm = TRUE)",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "> ",
        "View(resample)",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n\nRestarting R session...\n\n",
        "> ",
        "library(tidyverse)",
        "── \u001B[1mAttaching core tidyverse packages\u001B[22m ───────────────────────────────────────────────────────── tidyverse 2.0.0 ──\n\u001B[32m✔\u001B[39m \u001B[34mdplyr    \u001B[39m 1.1.4     \u001B[32m✔\u001B[39m \u001B[34mreadr    \u001B[39m 2.1.5\n\u001B[32m✔\u001B[39m \u001B[34mforcats  \u001B[39m 1.0.0     \u001B[32m✔\u001B[39m \u001B[34mstringr  \u001B[39m 1.5.1\n\u001B[32m✔\u001B[39m \u001B[34mggplot2  \u001B[39m 3.5.1     \u001B[32m✔\u001B[39m \u001B[34mtibble   \u001B[39m 3.2.1\n\u001B[32m✔\u001B[39m \u001B",
        "[34mlubridate\u001B[39m 1.9.4     \u001B[32m✔\u001B[39m \u001B[34mtidyr    \u001B[39m 1.3.1\n\u001B[32m✔\u001B[39m \u001B[34mpurrr    \u001B[39m 1.0.4     \n── \u001B[1mConflicts\u001B[22m ─────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32mfilter()\u001B[39m masks \u001B[34mstats\u001B[39m::filter()\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32",
        "mlag()\u001B[39m    masks \u001B[34mstats\u001B[39m::lag()\n\u001B[36mℹ\u001B[39m Use the \u001B]8;;http://conflicted.r-lib.org/\u0007conflicted package\u001B]8;;\u0007 to force all conflicts to become errors\n",
        "> ",
        "# Create an example population",
        "> ",
        "sample <- c(\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"s\",\"t\")",
        "> ",
        "group <- c(rep(1,5), rep(2,6), rep(3,8))",
        "> ",
        "wgt <- c(1.0, 0.3, 0.6, 1.7, 1.4, # Group 1 adds up to 5",
        "+ ",
        "         1.1, 1.4, 0.9, 0.7, 1.3, 0.6, # Group 2 adds up to 6",
        "+ ",
        "         1.2, 0.9, 1.5, 1.1, 0.6, 0.7, 1.0, 1.0) # Group 3 adds up to 8",
        "> ",
        "df <- data.frame(sample, group, wgt)",
        "> ",
        "df",
        "   sample group wgt\n1       a     1 1.0\n2       b     1 0.3\n3       c     1 0.6\n4       d     1 1.7\n5       e     1 1.4\n6       f     2 1.1\n7       g     2 1.4\n8       h     2 0.9\n9       i     2 0.7\n10      j     2 1.3\n11      k     2 0.6\n12      l     3 1.2\n13      m     3 0.9\n14      n     3 1.5\n15      o     3 1.1\n16      p     3 0.6\n17      q     3 0.7\n18      s     3 1.0\n19      t     3 1.0\n",
        "> ",
        "sum(df$wgt)",
        "[1] 19\n",
        "> ",
        "sum(df$wgt[df$group == 1])",
        "[1] 5\n",
        "> ",
        "# Original weight per group",
        "> ",
        "grp_weights <- df %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt), na.rm = TRUE)",
        "> ",
        "# Resample",
        "> ",
        "n <- nrow(df)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt), na.rm = TRUE)",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\"))",
        "> ",
        "View(resample)",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "resample$grp_wgt",
        " [1] 6 6 8 5 6 5 5 8 6 5 6 5 8 6 8 8 6 6 5\n",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "rlang::last_trace()",
        "\u001B[1m\u001B[34m<error/dplyr:::mutate_error>\u001B[39m\u001B[22m\n\u001B[1m\u001B[33mError\u001B[39m in \u001B[1m\u001B[94m`mutate()`\u001B[39m\u001B[1m:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n---\n\u001B[1mBacktrace:\u001B[22m\n\u001B[90m    \u001B[39m▆\n\u001B[90m 1. \u001B[39m├─... %>% mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))\n\u001B[90m 2. \u001B[39m├─\u001B[1mdplyr\u001B[22m::mutate(., wgt_ = wgt * (grp_wgt/resample_grp_wgt))\n\u001B[90m 3. \u001B[39m└─\u001B[1m\u001B[94mdplyr:::mutat",
        "e.data.frame(\u001B[39m\u001B[22m., wgt_ = wgt * (grp_wgt/resample_grp_wgt)\u001B[1m\u001B[94m)\u001B[39m\u001B[22m\n\u001B[90m 4. \u001B[39m  └─dplyr:::mutate_cols(.data, dplyr_quosures(...), by)\n\u001B[90m 5. \u001B[39m    ├\u001B[38;5;246m─\u001B[1mbase\u001B[22m::withCallingHandlers(...)\u001B[39m\n\u001B[90m 6. \u001B[39m    └─\u001B[1mdplyr\u001B[22m:::mutate_col(dots[[i]], data, mask, new_columns)\n\u001B[90m 7. \u001B[39m      └─mask$eval_all_mutate(quo)\n\u001B[90m 8. \u001B[39m        └─\u001B[1mdplyr\u001B[22m (local) eval()\n\u001B[90mRun \u001B]8;;x-r-run:rlang::last_trace(drop = FALSE)\u0007rlang::last_trace(dr",
        "op = FALSE)\u001B]8;;\u0007 to see 3 hidden frames.\u001B[39m\n",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "library(tidyverse)",
        "> ",
        "# Create an example population",
        "> ",
        "sample <- c(\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"s\",\"t\")",
        "> ",
        "group <- c(rep(1,5), rep(2,6), rep(3,8))",
        "> ",
        "wgt <- c(1.0, 0.3, 0.6, 1.7, 1.4, # Group 1 adds up to 5",
        "+ ",
        "         1.1, 1.4, 0.9, 0.7, 1.3, 0.6, # Group 2 adds up to 6",
        "+ ",
        "         1.2, 0.9, 1.5, 1.1, 0.6, 0.7, 1.0, 1.0) # Group 3 adds up to 8",
        "> ",
        "df <- data.frame(sample, group, wgt)",
        "> ",
        "df",
        "   sample group wgt\n1       a     1 1.0\n2       b     1 0.3\n3       c     1 0.6\n4       d     1 1.7\n5       e     1 1.4\n6       f     2 1.1\n7       g     2 1.4\n8       h     2 0.9\n9       i     2 0.7\n10      j     2 1.3\n11      k     2 0.6\n12      l     3 1.2\n13      m     3 0.9\n14      n     3 1.5\n15      o     3 1.1\n16      p     3 0.6\n17      q     3 0.7\n18      s     3 1.0\n19      t     3 1.0\n",
        "> ",
        "sum(df$wgt)",
        "[1] 19\n",
        "> ",
        "sum(df$wgt[df$group == 1])",
        "[1] 5\n",
        "> ",
        "# Original weight per group",
        "> ",
        "grp_weights <- df %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "# Resample",
        "> ",
        "n <- nrow(df)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "View(grp_weights)",
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "> ",
        "View(resample)",
        "> ",
        "library(tidyverse)",
        "> ",
        "# Create an example population",
        "> ",
        "sample <- c(\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"s\",\"t\")",
        "> ",
        "group <- c(rep(1,5), rep(2,6), rep(3,8))",
        "> ",
        "wgt <- c(1.0, 0.3, 0.6, 1.7, 1.4, # Group 1 adds up to 5",
        "+ ",
        "         1.1, 1.4, 0.9, 0.7, 1.3, 0.6, # Group 2 adds up to 6",
        "+ ",
        "         1.2, 0.9, 1.5, 1.1, 0.6, 0.7, 1.0, 1.0) # Group 3 adds up to 8",
        "> ",
        "df <- data.frame(sample, group, wgt)",
        "> ",
        "df",
        "   sample group wgt\n1       a     1 1.0\n2       b     1 0.3\n3       c     1 0.6\n4       d     1 1.7\n5       e     1 1.4\n6       f     2 1.1\n7       g     2 1.4\n8       h     2 0.9\n9       i     2 0.7\n10      j     2 1.3\n11      k     2 0.6\n12      l     3 1.2\n13      m     3 0.9\n14      n     3 1.5\n15      o     3 1.1\n16      p     3 0.6\n17      q     3 0.7\n18      s     3 1.0\n19      t     3 1.0\n",
        "> ",
        "sum(df$wgt)",
        "[1] 19\n",
        "> ",
        "sum(df$wgt[df$group == 1])",
        "[1] 5\n",
        "> ",
        "# Original weight per group",
        "> ",
        "grp_weights <- df %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "View(grp_weights)",
        "> ",
        "# Resample",
        "> ",
        "n <- nrow(df)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "View(resample_grp_weights)",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\"))",
        "> ",
        "View(resample)",
        "> ",
        "View(resample)",
        "> ",
        "# Check the adjusted weights",
        "> ",
        "adj_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt_, na.rm = TRUE))",
        "\u001B[1m\u001B[33mError\u001B[39m in `summarise()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `grp_wgt = sum(wgt_, na.rm = TRUE)`.\n\u001B[36mℹ\u001B[38;5;252m In group 1: `group = 1`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'wgt_' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "# Check the adjusted weights",
        "> ",
        "adj_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt_, na.rm = TRUE))",
        "\u001B[1m\u001B[33mError\u001B[39m in `summarise()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `grp_wgt = sum(wgt_, na.rm = TRUE)`.\n\u001B[36mℹ\u001B[38;5;252m In group 1: `group = 1`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'wgt_' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "View(resample)",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_ = wgt * (grp_wgt/resample_grp_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'grp_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n\nRestarting R session...\n\n",
        "> ",
        "library(tidyverse)",
        "── \u001B[1mAttaching core tidyverse packages\u001B[22m ───────────────────────────────────────────────────────── tidyverse 2.0.0 ──\n\u001B[32m✔\u001B[39m \u001B[34mdplyr    \u001B[39m 1.1.4     \u001B[32m✔\u001B[39m \u001B[34mreadr    \u001B[39m 2.1.5\n\u001B[32m✔\u001B[39m \u001B[34mforcats  \u001B[39m 1.0.0     \u001B[32m✔\u001B[39m \u001B[34mstringr  \u001B[39m 1.5.1\n\u001B[32m✔\u001B[39m \u001B[34mggplot2  \u001B[39m 3.5.1     \u001B[32m✔\u001B[39m \u001B[34mtibble   \u001B[39m 3.2.1\n\u001B[32m✔\u001B[39m \u001B",
        "[34mlubridate\u001B[39m 1.9.4     \u001B[32m✔\u001B[39m \u001B[34mtidyr    \u001B[39m 1.3.1\n\u001B[32m✔\u001B[39m \u001B[34mpurrr    \u001B[39m 1.0.4     \n── \u001B[1mConflicts\u001B[22m ─────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32mfilter()\u001B[39m masks \u001B[34mstats\u001B[39m::filter()\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32",
        "mlag()\u001B[39m    masks \u001B[34mstats\u001B[39m::lag()\n\u001B[36mℹ\u001B[39m Use the \u001B]8;;http://conflicted.r-lib.org/\u0007conflicted package\u001B]8;;\u0007 to force all conflicts to become errors\n",
        "> ",
        "# Create an example population",
        "> ",
        "sample <- c(\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"s\",\"t\")",
        "> ",
        "group <- c(rep(1,5), rep(2,6), rep(3,8))",
        "> ",
        "wgt <- c(1.0, 0.3, 0.6, 1.7, 1.4, # Group 1 adds up to 5",
        "+ ",
        "         1.1, 1.4, 0.9, 0.7, 1.3, 0.6, # Group 2 adds up to 6",
        "+ ",
        "         1.2, 0.9, 1.5, 1.1, 0.6, 0.7, 1.0, 1.0) # Group 3 adds up to 8",
        "> ",
        "df <- data.frame(sample, group, wgt)",
        "> ",
        "df",
        "   sample group wgt\n1       a     1 1.0\n2       b     1 0.3\n3       c     1 0.6\n4       d     1 1.7\n5       e     1 1.4\n6       f     2 1.1\n7       g     2 1.4\n8       h     2 0.9\n9       i     2 0.7\n10      j     2 1.3\n11      k     2 0.6\n12      l     3 1.2\n13      m     3 0.9\n14      n     3 1.5\n15      o     3 1.1\n16      p     3 0.6\n17      q     3 0.7\n18      s     3 1.0\n19      t     3 1.0\n",
        "> ",
        "sum(df$wgt)",
        "[1] 19\n",
        "> ",
        "sum(df$wgt[df$group == 1])",
        "[1] 5\n",
        "> ",
        "# Original weight per group",
        "> ",
        "grp_weights <- df %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "# Resample",
        "> ",
        "n <- nrow(df)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "> ",
        "# Check the adjusted weights",
        "> ",
        "adj_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt_, na.rm = TRUE))",
        "> ",
        "View(adj_grp_weights)",
        "> ",
        "View(grp_weights)",
        "> ",
        "View(adj_grp_weights)",
        "> ",
        "View(resample_grp_weights)",
        "> ",
        "View(adj_grp_weights)",
        "> ",
        "View(grp_weights)",
        "\nRestarting R session...\n\n",
        "> ",
        "library(tidyverse)",
        "── \u001B[1mAttaching core tidyverse packages\u001B[22m ───────────────────────────────────────────────────────── tidyverse 2.0.0 ──\n\u001B[32m✔\u001B[39m \u001B[34mdplyr    \u001B[39m 1.1.4     \u001B[32m✔\u001B[39m \u001B[34mreadr    \u001B[39m 2.1.5\n\u001B[32m✔\u001B[39m \u001B[34mforcats  \u001B[39m 1.0.0     \u001B[32m✔\u001B[39m \u001B[34mstringr  \u001B[39m 1.5.1\n\u001B[32m✔\u001B[39m \u001B[34mggplot2  \u001B[39m 3.5.1     \u001B[32m✔\u001B[39m \u001B[34mtibble   \u001B[39m 3.2.1\n\u001B[32m✔\u001B[39m \u001B",
        "[34mlubridate\u001B[39m 1.9.4     \u001B[32m✔\u001B[39m \u001B[34mtidyr    \u001B[39m 1.3.1\n\u001B[32m✔\u001B[39m \u001B[34mpurrr    \u001B[39m 1.0.4     \n── \u001B[1mConflicts\u001B[22m ─────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32mfilter()\u001B[39m masks \u001B[34mstats\u001B[39m::filter()\n\u001B[31m✖\u001B[39m \u001B[34mdplyr\u001B[39m::\u001B[32",
        "mlag()\u001B[39m    masks \u001B[34mstats\u001B[39m::lag()\n\u001B[36mℹ\u001B[39m Use the \u001B]8;;http://conflicted.r-lib.org/\u0007conflicted package\u001B]8;;\u0007 to force all conflicts to become errors\n",
        "> ",
        "# Create an example population",
        "> ",
        "sample <- c(\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"s\",\"t\")",
        "> ",
        "group <- c(rep(1,5), rep(2,6), rep(3,8))",
        "> ",
        "wgt <- c(1.0, 0.3, 0.6, 1.7, 1.4, # Group 1 adds up to 5",
        "+ ",
        "         1.1, 1.4, 0.9, 0.7, 1.3, 0.6, # Group 2 adds up to 6",
        "+ ",
        "         1.2, 0.9, 1.5, 1.1, 0.6, 0.7, 1.0, 1.0) # Group 3 adds up to 8",
        "> ",
        "df <- data.frame(sample, group, wgt)",
        "> ",
        "df",
        "   sample group wgt\n1       a     1 1.0\n2       b     1 0.3\n3       c     1 0.6\n4       d     1 1.7\n5       e     1 1.4\n6       f     2 1.1\n7       g     2 1.4\n8       h     2 0.9\n9       i     2 0.7\n10      j     2 1.3\n11      k     2 0.6\n12      l     3 1.2\n13      m     3 0.9\n14      n     3 1.5\n15      o     3 1.1\n16      p     3 0.6\n17      q     3 0.7\n18      s     3 1.0\n19      t     3 1.0\n",
        "> ",
        "sum(df$wgt)",
        "[1] 19\n",
        "> ",
        "sum(df$wgt[df$group == 1])",
        "[1] 5\n",
        "> ",
        "sum(df$wgt[df$group == 2])",
        "[1] 6\n",
        "> ",
        "sum(df$wgt[df$group == 3])",
        "[1] 8\n",
        "> ",
        "# Original weight per group",
        "> ",
        "grp_weights <- df %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "grp_weights",
        "\u001B[38;5;246m# A tibble: 3 × 2\u001B[39m\n  group grp_wgt\n  \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m   \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m\n\u001B[38;5;250m1\u001B[39m     1       5\n\u001B[38;5;250m2\u001B[39m     2       6\n\u001B[38;5;250m3\u001B[39m     3       8\n",
        "> ",
        "# Resample",
        "> ",
        "n <- nrow(df)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "resample",
        "     sample group wgt\n4         d     1 1.7\n8         h     2 0.9\n4.1       d     1 1.7\n13        m     3 0.9\n5         e     1 1.4\n15        o     3 1.1\n10        j     2 1.3\n6         f     2 1.1\n8.1       h     2 0.9\n1         a     1 1.0\n7         g     2 1.4\n11        k     2 0.6\n19        t     3 1.0\n3         c     1 0.6\n19.1      t     3 1.0\n19.2      t     3 1.0\n5.1       e     1 1.4\n14        n     3 1.5\n13.1      m     3 0.9\n",
        "> ",
        "View(resample)",
        "> ",
        "resample <- df[sample.int(n, n, replace = TRUE), ]",
        "> ",
        "resample",
        "     sample group wgt\n18        s     3 1.0\n10        j     2 1.3\n17        q     3 0.7\n10.1      j     2 1.3\n4         d     1 1.7\n11        k     2 0.6\n18.1      s     3 1.0\n12        l     3 1.2\n18.2      s     3 1.0\n7         g     2 1.4\n16        p     3 0.6\n5         e     1 1.4\n17.1      q     3 0.7\n5.1       e     1 1.4\n5.2       e     1 1.4\n3         c     1 0.6\n6         f     2 1.1\n13        m     3 0.9\n13.1      m     3 0.9\n",
        "> ",
        "# Total wight per group in the new sample",
        "> ",
        "resample_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(resample_grp_wgt = sum(wgt, na.rm = TRUE))",
        "> ",
        "resample_grp_weights",
        "\u001B[38;5;246m# A tibble: 3 × 2\u001B[39m\n  group resample_grp_wgt\n  \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m            \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m\n\u001B[38;5;250m1\u001B[39m     1              6.5\n\u001B[38;5;250m2\u001B[39m     2              5.7\n\u001B[38;5;250m3\u001B[39m     3              8  \n",
        "> ",
        "# Merge the original and resample stratum weights",
        "> ",
        "resample <- resample %>% ",
        "+ ",
        "  left_join(grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  left_join(resample_grp_weights, by = c(\"group\")) %>% ",
        "+ ",
        "  # Adjust weights so each group's total matches the original total",
        "+ ",
        "  mutate(wgt_ = wgt * (grp_wgt / resample_grp_wgt))",
        "> ",
        "resample",
        "   sample group wgt grp_wgt resample_grp_wgt      wgt_\n1       s     3 1.0       8              8.0 1.0000000\n2       j     2 1.3       6              5.7 1.3684211\n3       q     3 0.7       8              8.0 0.7000000\n4       j     2 1.3       6              5.7 1.3684211\n5       d     1 1.7       5              6.5 1.3076923\n6       k     2 0.6       6              5.7 0.6315789\n7       s     3 1.0       8              8.0 1.0000000\n8       l     3 1.2       8              8.0 1.2000000\n9       s     3 1",
        ".0       8              8.0 1.0000000\n10      g     2 1.4       6              5.7 1.4736842\n11      p     3 0.6       8              8.0 0.6000000\n12      e     1 1.4       5              6.5 1.0769231\n13      q     3 0.7       8              8.0 0.7000000\n14      e     1 1.4       5              6.5 1.0769231\n15      e     1 1.4       5              6.5 1.0769231\n16      c     1 0.6       5              6.5 0.4615385\n17      f     2 1.1       6              5.7 1.1578947\n18      m     3 0.9       8       ",
        "       8.0 0.9000000\n19      m     3 0.9       8              8.0 0.9000000\n",
        "> ",
        "# Check the adjusted weights",
        "> ",
        "adj_grp_weights <- resample %>% ",
        "+ ",
        "  group_by(group) %>% ",
        "+ ",
        "  summarise(grp_wgt = sum(wgt_, na.rm = TRUE))",
        "> ",
        "adj_grp_weights",
        "\u001B[38;5;246m# A tibble: 3 × 2\u001B[39m\n  group grp_wgt\n  \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m   \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m\n\u001B[38;5;250m1\u001B[39m     1       5\n\u001B[38;5;250m2\u001B[39m     2       6\n\u001B[38;5;250m3\u001B[39m     3       8\n\nRestarting R session...\n\n",
        "> ",
        "library(here)",
        "here() starts at /Users/chisatoito/Library/CloudStorage/OneDrive-Charité-UniversitätsmedizinBerlin/My Documents/Projects/NAKO-837\n",
        "> ",
        "library(srvyr)",
        "\nAttaching package: ‘srvyr’\n\nThe following object is masked from ‘package:stats’:\n\n    filter\n\n",
        "> ",
        "library(dplyr)",
        "\nAttaching package: ‘dplyr’\n\nThe following objects are masked from ‘package:stats’:\n\n    filter, lag\n\nThe following objects are masked from ‘package:base’:\n\n    intersect, setdiff, setequal, union\n\n",
        "> ",
        "library(tidyr)",
        "> ",
        "# Step 1: Read in the cleaned up NAKO-837 data",
        "> ",
        "dat_w_all <- read.csv(here(\"out_data\",\"df_nako_clean.csv\"))",
        "> ",
        "dat_w_all <- dat_w_all %>% ",
        "+ ",
        "  # create a new variable grouping years: 2014-2016 & 2017-2019",
        "+ ",
        "  mutate(basis_udat_y_tri = ifelse(basis_udat_y %in% c(2014, 2015, 2016), 2015,",
        "+ ",
        "                                   ifelse(basis_udat_y %in% c(2017, 2018, 2019), 2018, basis_udat_y))) %>%",
        "+ ",
        "  mutate(basis_sex = as.factor(basis_sex)) ",
        "> ",
        "# Step X: Compute the total sum of weights in the original dataset",
        "> ",
        "total_original_weight <- sum(dat_w_all$wgt_total_16sc, na.rm = TRUE)",
        "> ",
        "# Step 1: Read in the cleaned up NAKO-837 data",
        "> ",
        "dat_w_all <- read.csv(here(\"out_data\",\"df_nako_clean.csv\"))",
        "> ",
        "dat_w_all <- dat_w_all %>% ",
        "+ ",
        "  # create a new variable grouping years: 2014-2016 & 2017-2019",
        "+ ",
        "  mutate(basis_udat_y_tri = ifelse(basis_udat_y %in% c(2014, 2015, 2016), 2015,",
        "+ ",
        "                                   ifelse(basis_udat_y %in% c(2017, 2018, 2019), 2018, basis_udat_y))) %>%",
        "+ ",
        "  mutate(basis_sex = as.factor(basis_sex)) ",
        "> ",
        "# Step 2: Create the survey design object with weights",
        "> ",
        "design <- dat_w_all %>%",
        "+ ",
        "  filter(!is.na(wgt_total_16sc)) %>%  # there are 59 participants without weights",
        "+ ",
        "  as_survey_design(weights = wgt_total_16sc, strata = wgt_geosc_16sc)",
        "> ",
        "# Step X: Compute the total sum of weights in the original dataset",
        "> ",
        "total_original_weight <- sum(dat_w_all$wgt_total_16sc, na.rm = TRUE)",
        "> ",
        "# Step 3: Compute the total weight for each study center in the original dataset",
        "> ",
        "sc_weights <- dat_w_all %>%",
        "+ ",
        "  group_by(wgt_geosc_16sc) %>%",
        "+ ",
        "  summarise(sc_original_wgt = sum(wgt_total_16sc, na.rm = TRUE), .groups = \"drop\")",
        "> ",
        "View(sc_weights)",
        "> ",
        "  n <- nrow(dat_w_all)",
        "> ",
        "  # Step 4: Resample the dataset with replacement",
        "> ",
        "  #resample <- dat_w_all %>%",
        "> ",
        "  #  sample_n(nrow(dat_w_all), replace = TRUE) # Use sample.int() instead?",
        "> ",
        "  resample <- dat_w_all[sample.int(n, n, replace = TRUE), ] # this is faster ",
        "> ",
        "View(resample)",
        "> ",
        "sc_resample_weights",
        "Error: object 'sc_resample_weights' not found\n",
        "> ",
        "  # Step 5: Resample the dataset with replacement",
        "> ",
        "  #resample <- dat_w_all %>%",
        "> ",
        "  #  sample_n(nrow(dat_w_all), replace = TRUE) # Use sample.int() instead?",
        "> ",
        "  resample <- dat_w_all[sample.int(n, n, replace = TRUE), ] # this is faster ",
        "> ",
        "  # Step 6: Compute the total weight for each study centre in the ith sample",
        "> ",
        "  sc_resample_weights <- resample %>%",
        "+ ",
        "    group_by(wgt_geosc_16sc) %>%",
        "+ ",
        "    summarise(sc_resample_wgt = sum(wgt_total_16sc, na.rm = TRUE)) #, .groups = \"drop\")",
        "> ",
        "sc_resample_weights",
        "\u001B[38;5;246m# A tibble: 17 × 2\u001B[39m\n   wgt_geosc_16sc sc_resample_wgt\n            \u001B[3m\u001B[38;5;246m<int>\u001B[39m\u001B[23m           \u001B[3m\u001B[38;5;246m<dbl>\u001B[39m\u001B[23m\n\u001B[38;5;250m 1\u001B[39m             11          \u001B[4m2\u001B[24m\u001B[4m0\u001B[24m696.\n\u001B[38;5;250m 2\u001B[39m             12           \u001B[4m9\u001B[24m569.\n\u001B[38;5;250m 3\u001B[39m             21          \u001B[4m1\u001B[24m\u001B[4m0\u001B[24m020.\n\u001B[38;5;250m 4\u001B[39m             22           \u001B[4m9\u001B[24m781.\n\u001B[38;5;250m 5\u001B[39m             23          \u001B[4m1\u001B[24m\u001B[4m0\u001B[24m006.\n\u001B[38;5;250m 6\u001B[39m             31   ",
        "       \u001B[4m1\u001B[24m\u001B[4m0\u001B[24m801.\n\u001B[38;5;250m 7\u001B[39m             32           \u001B[4m9\u001B[24m940.\n\u001B[38;5;250m 8\u001B[39m             33           \u001B[4m9\u001B[24m323.\n\u001B[38;5;250m 9\u001B[39m             41           \u001B[4m9\u001B[24m967.\n\u001B[38;5;250m10\u001B[39m             42          \u001B[4m1\u001B[24m\u001B[4m1\u001B[24m008.\n\u001B[38;5;250m11\u001B[39m             50          \u001B[4m3\u001B[24m\u001B[4m1\u001B[24m125.\n\u001B[38;5;250m12\u001B[39m             61           \u001B[4m9\u001B[24m900.\n\u001B[38;5;250m13\u001B[39m             62           \u001B[4m9\u001B[24m899.\n\u001B[38;5;250m14\u001B[39m             63          \u001B[4m1\u001B",
        "[24m\u001B[4m0\u001B[24m780.\n\u001B[38;5;250m15\u001B[39m             71           \u001B[4m9\u001B[24m602.\n\u001B[38;5;250m16\u001B[39m             81          \u001B[4m2\u001B[24m\u001B[4m2\u001B[24m195.\n\u001B[38;5;250m17\u001B[39m             \u001B[31mNA\u001B[39m              0 \n",
        "> ",
        "  # Step 7: Merge the original and new study centre weights",
        "> ",
        "  resample <- resample %>%",
        "+ ",
        "    left_join(sc_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    left_join(sc_resample_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    mutate(",
        "+ ",
        "      # Step 8: Adjust weights so that each stratum's total matches the original dataset",
        "+ ",
        "      wgt_total_16sc_ = wgt_total_16sc * (sc_original_wgt / sc_resample_wgt))",
        "> ",
        "resample ",
        "   basis_udat_m basis_udat_y basis_sex basis_age basis_ageclass basis_uort deceased wgt_total_18sc\n1            11         2017         2        58             50        813       NA       1.002405\n2             3         2017         1        67             60         63       NA       0.592449\n3             1         2019         1        25             20         11       NA       3.341036\n4             8         2017         2        26             20         62       NA       0.796480\n5             7  ",
        "       2018         2        47             40         61       NA       0.168515\n6             1         2018         2        45             40         61       NA       1.929111\n7             6         2018         2        40             40         41       NA       0.717845\n8            12         2015         1        57             50         52       NA       3.087544\n9             2         2018         1        40             40         63       NA       0.445788\n10            8         2015      ",
        "   2        66             60         42       NA       0.388384\n11            6         2018         2        23             20         81       NA       2.473011\n12            2         2018         2        50             50         41       NA       0.237477\n13            1         2019         1        51             50         52       NA       0.150166\n14            6         2018         1        63             60         32       NA       0.239002\n15           11         2015         2        49   ",
        "          40         63       NA       0.522396\n16            3         2017         1        59             50         81       NA       1.069077\n17            7         2018         1        53             50         53       NA       0.368938\n18            7         2016         1        33             30         21       NA       7.668092\n19            2         2017         1        65             60         51       NA       0.945884\n20            4         2015         2        60             60     ",
        "    11       NA       0.068410\n21            5         2017         1        50             50         61       NA       0.838827\n22            8         2017         1        35             30         51       NA       4.441535\n23            2         2015         1        38             30         63       NA       5.654443\n   wgt_total_16sc wgt_geosc_18sc wgt_geosc_16sc d_an_minia1 a_emo_gad7_sum a_emo_gad7_cut10 a_emo_gad7_dia\n1        1.002405             81             81           2              4   ",
        "             0              1\n2        0.592449             63             63           2              5                0              2\n3        3.341036             11             11           2              0                0              0\n4        0.796480             62             62           2              3                0              1\n5        0.168515             61             61           2              3                0              1\n6        1.929111             61             61       ",
        "    2              2                0              1\n7        0.717845             41             41           2              3                0              1\n8        3.576026             52             50           1              7                0              2\n9        0.445788             63             63           2              3                0              1\n10       0.388384             42             42           2              2                0              1\n11       2.473011             8",
        "1             81           2              7                0              2\n12       0.237477             41             41           1              0                0              0\n13       0.173924             52             50           2              0                0              0\n14       0.239002             32             32           2              0                0              0\n15       0.522396             63             63           1              3                0              1\n16      ",
        " 1.069077             81             81           1              0                0              0\n17       0.396357             53             50           1              3                0              1\n18       7.668092             21             21           2              1                0              1\n19       0.713041             51             50           1              2                0              1\n20       0.068410             11             11           1              9                0 ",
        "             2\n21       0.838827             61             61           2              0                0              0\n22       3.348187             51             50           1              4                0              1\n23       5.654443             63             63           2             NA               NA             NA\n   a_emo_phq9_sum a_emo_phq9_kat a_emo_phq9_cut10 a_emo_phq9_dsm d_phq91_1 d_phq91_2 d_phq91_3 d_phq91_4\n1               4              0                0              0       ",
        "  1         0         1         1\n2               3              0                0              0         1         1         0         0\n3               2              0                0              0         0         0         1         0\n4               4              0                0              0         1         0         1         0\n5               0              0                0              0         0         0         0         0\n6               4              0                0         ",
        "     0         0         0         1         1\n7               4              0                0              0         1         1         0         1\n8               7              1                0              0         1         1         1         1\n9               2              0                0              0         0         0         1         1\n10              6              1                0              0         0         0         3         1\n11              3              0             ",
        "   0              0         1         0         0         1\n12              2              0                0              0         0         0         0         1\n13              0              0                0              0         0         0         0         0\n14              2              0                0              0         0         0         1         1\n15              8              1                0              1         2         1         0         1\n16              2              0",
        "                0              0         0         0         1         1\n17              4              0                0              0         1         0         1         1\n18              4              0                0              0         0         0         0         1\n19              3              0                0              0         1         0         1         1\n20             14              2                1              2         3         3         2         3\n21              1  ",
        "            0                0              0         0         0         0         1\n22              4              0                0              0         1         1         0         1\n23             NA             NA               NA             NA        NA        NA        NA        NA\n   d_phq91_5 d_phq91_6 d_phq91_7 d_phq91_8 d_phq91_9 d_phq92 d_gad7_1 d_gad7_2 d_gad7_3 d_gad7_4 d_gad7_5\n1          0         0         1         0         0       2        0        0        1        1        1\n2   ",
        "       0         0         1         0         0       2        1        1        1        0        0\n3          0         0         0         1         0       2        0        0        0        0        0\n4          1         1         0         0         0       2        1        0        0        1        0\n5          0         0         0         0         0      NA        1        0        0        1        0\n6          1         0         1         0         0       2        1        0        0     ",
        "   0        0\n7          0         0         1         0         0      11        0        1        0        0        1\n8          0         1         1         1         0       2        1        1        1        1        1\n9          0         0         0         0         0       2        0        0        0        1        1\n10         1         0         1         0         0       2        1        0        0        0        1\n11         1         0         0         0         0      11        0     ",
        "   1        1        2        0\n12         1         0         0         0         0       2        0        0        0        0        0\n13         0         0         0         0         0      NA        0        0        0        0        0\n14         0         0         0         0         0       2        0        0        0        0        0\n15         1         1         1         0         1      11        1        0        0        0        0\n16         0         0         0         0         0    ",
        "   2        0        0        0        0        0\n17         0         0         1         0         0      11        1        0        0        1        0\n18         1         1         0         0         1      11        0        0        0        1        0\n19         0         0         0         0         0      11        0        0        1        1        0\n20         0         3         0         0         0      11        1        1        3        3        0\n21         0         0         0      ",
        "   0         0      11        0        0        0        0        0\n22         0         1         0         0         0      11        1        0        1        1        0\n23        NA        NA        NA        NA        NA      NA       NA       NA       NA       NA       NA\n   d_gad7_6 d_gad7_7 a_emo_phq9_sum_check a_emo_gad7_sum_check basis_udat_y_tri sc_original_wgt sc_resample_wgt\n1         1        0                    4                    4             2018        22006.00       22195.454\n2       ",
        "  1        1                    3                    5             2018        10478.00       10780.151\n3         0        0                    2                    0             2018        20584.55       20696.070\n4         1        0                    4                    3             2018        10057.96        9899.187\n5         1        0                    0                    3             2018        10014.65        9899.744\n6         1        0                    4                    2          ",
        "   2018        10014.65        9899.744\n7         1        0                    4                    3             2018        10110.74        9966.979\n8         1        1                    7                    7             2015        31025.92       31124.999\n9         1        0                    2                    3             2018        10478.00       10780.151\n10        0        0                    6                    2             2015        10845.00       11008.074\n11        2        1    ",
        "                3                    7             2018        22006.00       22195.454\n12        0        0                    2                    0             2018        10110.74        9966.979\n13        0        0                    0                    0             2018        31025.92       31124.999\n14        0        0                    2                    0             2018        10002.89        9940.169\n15        1        1                    8                    3             2015        1",
        "0478.00       10780.151\n16        0        0                    2                    0             2018        22006.00       22195.454\n17        1        0                    4                    3             2018        31025.92       31124.999\n18        0        0                    4                    1             2015        10267.79       10020.286\n19        0        0                    3                    2             2018        31025.92       31124.999\n20        1        0                   1",
        "4                    9             2015        20584.55       20696.070\n21        0        0                    1                    0             2018        10014.65        9899.744\n22        1        0                    4                    4             2018        31025.92       31124.999\n23       NA       NA                   NA                   NA             2015        10478.00       10780.151\n   wgt_total_16sc_\n1       0.99384873\n2       0.57584356\n3       3.32303264\n4       0.80925509\n5       0",
        ".17047089\n6       1.95150141\n7       0.72819891\n8       3.56464265\n9       0.43329324\n10      0.38263049\n11      2.45190201\n12      0.24090227\n13      0.17337036\n14      0.24051003\n15      0.50775404\n16      1.05995163\n17      0.39509530\n18      7.85749397\n19      0.71077122\n20      0.06804137\n21      0.84856293\n22      3.33752892\n23      5.49595760\n [ reached 'max' / getOption(\"max.print\") -- omitted 204733 rows ]\n",
        "> ",
        "View(resample)",
        "> ",
        "  # Step 7: Merge the original and new study centre weights",
        "> ",
        "  resample <- resample %>%",
        "+ ",
        "    left_join(sc_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    left_join(sc_resample_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    mutate(",
        "+ ",
        "      # Step 8: Adjust weights so that each stratum's total matches the original dataset",
        "+ ",
        "      wgt_total_16sc = wgt_total_16sc * (sc_original_wgt / sc_resample_wgt))",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `wgt_total_16sc = wgt_total_16sc * (sc_original_wgt/sc_resample_wgt)`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'sc_original_wgt' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "  # Step 5: Resample the dataset with replacement",
        "> ",
        "  #resample <- dat_w_all %>%",
        "> ",
        "  #  sample_n(nrow(dat_w_all), replace = TRUE) # Use sample.int() instead?",
        "> ",
        "  resample <- dat_w_all[sample.int(n, n, replace = TRUE), ] # this is faster ",
        "> ",
        "  # Step 6: Compute the total weight for each study centre in the ith sample",
        "> ",
        "  sc_resample_weights <- resample %>%",
        "+ ",
        "    group_by(wgt_geosc_16sc) %>%",
        "+ ",
        "    summarise(sc_resample_wgt = sum(wgt_total_16sc, na.rm = TRUE)) #, .groups = \"drop\")",
        "> ",
        "  # Step 7: Merge the original and new study centre weights",
        "> ",
        "  resample <- resample %>%",
        "+ ",
        "    left_join(sc_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    left_join(sc_resample_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    mutate(",
        "+ ",
        "      # Step 8: Adjust weights so that each stratum's total matches the original dataset",
        "+ ",
        "      wgt_total_16sc = wgt_total_16sc * (sc_original_wgt / sc_resample_wgt))",
        "> ",
        "# check weights",
        "> ",
        "centers <- sort(unique(resample$wgt_geosc_16sc), na.last = TRUE)",
        "> ",
        "for (c in centers){",
        "+ ",
        "  print(sum(resample$wgt_total_16sc[resample$wgt_geosc_16sc == c], na.rm = TRUE))",
        "+ ",
        "}",
        "[1] 20584.55\n[1] 10015\n[1] 10267.79\n[1] 10052.88\n[1] 10013.79\n[1] 10630.78\n[1] 10002.89\n[1] 9080.369\n[1] 10110.74\n[1] 10845\n[1] 31025.92\n[1] 10014.65\n[1] 10057.96\n[1] 10478\n[1] 9483.082\n[1] 22006\n[1] 0\n",
        "> ",
        "View(sc_weights)",
        "> ",
        "  # Step 9: Create a survey design object for the ith sample",
        "> ",
        "  resample_design <- resample %>%",
        "+ ",
        "    filter(!is.na(wgt_total_16sc)) %>%",
        "+ ",
        "    as_survey_design(weights = wgt_total_16sc, strata = wgt_geosc_16sc)",
        "> ",
        "  # Step 10a: Estimate the age- and sex-specific anxiety prevalence for the ith sample",
        "> ",
        "  result_a <- resample_design %>%",
        "+ ",
        "    group_by(basis_udat_y_tri, basis_sex, basis_ageclass) %>%",
        "+ ",
        "    summarise(prev_a = survey_mean(a_emo_gad7_cut10, vartype = \"ci\", na.rm = TRUE)) %>%",
        "+ ",
        "    mutate(iteration = i)  # Add iteration number to the result",
        "\u001B[1m\u001B[33mError\u001B[39m in `mutate()`:\u001B[22m\n\u001B[38;5;252m\u001B[36mℹ\u001B[38;5;252m In argument: `iteration = i`.\n\u001B[36mℹ\u001B[38;5;252m In group 1: `basis_udat_y_tri = 2015` `basis_sex = 1`.\u001B[39m\n\u001B[1mCaused by error:\u001B[22m\n\u001B[33m!\u001B[39m object 'i' not found\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n\nRestarting R session...\n\n",
        "> ",
        "library(here)",
        "here() starts at /Users/chisatoito/Library/CloudStorage/OneDrive-Charité-UniversitätsmedizinBerlin/My Documents/Projects/NAKO-837\n",
        "> ",
        "library(srvyr)",
        "\nAttaching package: ‘srvyr’\n\nThe following object is masked from ‘package:stats’:\n\n    filter\n\n",
        "> ",
        "library(dplyr)",
        "\nAttaching package: ‘dplyr’\n\nThe following objects are masked from ‘package:stats’:\n\n    filter, lag\n\nThe following objects are masked from ‘package:base’:\n\n    intersect, setdiff, setequal, union\n\n",
        "> ",
        "library(tidyr)",
        "> ",
        "# Step 1: Read in the cleaned up NAKO-837 data",
        "> ",
        "dat_w_all <- read.csv(here(\"out_data\",\"df_nako_clean.csv\"))",
        "> ",
        "dat_w_all <- dat_w_all %>% ",
        "+ ",
        "  # create a new variable grouping years: 2014-2016 & 2017-2019",
        "+ ",
        "  mutate(basis_udat_y_tri = ifelse(basis_udat_y %in% c(2014, 2015, 2016), 2015,",
        "+ ",
        "                                   ifelse(basis_udat_y %in% c(2017, 2018, 2019), 2018, basis_udat_y))) %>%",
        "+ ",
        "  mutate(basis_sex = as.factor(basis_sex)) ",
        "> ",
        "# Step 2: Create the survey design object with weights",
        "> ",
        "design <- dat_w_all %>%",
        "+ ",
        "  filter(!is.na(wgt_total_16sc)) %>%  # there are 59 participants without weights",
        "+ ",
        "  as_survey_design(weights = wgt_total_16sc, strata = wgt_geosc_16sc)",
        "> ",
        "# Step 3: Compute the total weight for each study center in the original dataset",
        "> ",
        "sc_weights <- dat_w_all %>%",
        "+ ",
        "  group_by(wgt_geosc_16sc) %>%",
        "+ ",
        "  summarise(sc_original_wgt = sum(wgt_total_16sc, na.rm = TRUE), .groups = \"drop\")",
        "> ",
        "# Step 4: Resample and repeat the analysis 1000 times",
        "> ",
        "n_iterations <- 5 # Ultimately we want 2000",
        "> ",
        "# Placeholder for the results",
        "> ",
        "resample_results_a <- list()",
        "> ",
        "resample_results_d <- list()",
        "> ",
        "# Perform resampling and analysis",
        "> ",
        "for (i in 1:n_iterations) {",
        "+ ",
        "  n <- nrow(dat_w_all)",
        "+ ",
        "  ",
        "+ ",
        "  # Step 5: Resample the dataset with replacement",
        "+ ",
        "  #resample <- dat_w_all %>%",
        "+ ",
        "  #  sample_n(nrow(dat_w_all), replace = TRUE) # Use sample.int() instead?",
        "+ ",
        "  resample <- dat_w_all[sample.int(n, n, replace = TRUE), ] # this is faster ",
        "+ ",
        "  ",
        "+ ",
        "  # Step 6: Compute the total weight for each study centre in the ith sample",
        "+ ",
        "  sc_resample_weights <- resample %>%",
        "+ ",
        "    group_by(wgt_geosc_16sc) %>%",
        "+ ",
        "    summarise(sc_resample_wgt = sum(wgt_total_16sc, na.rm = TRUE)) #, .groups = \"drop\")",
        "+ ",
        "  ",
        "+ ",
        "  # Step 7: Merge the original and new study centre weights",
        "+ ",
        "  resample <- resample %>%",
        "+ ",
        "    left_join(sc_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    left_join(sc_resample_weights, by = c(\"wgt_geosc_16sc\")) %>%",
        "+ ",
        "    mutate(",
        "+ ",
        "      # Step 8: Adjust weights so that each stratum's total matches the original dataset",
        "+ ",
        "      wgt_total_16sc = wgt_total_16sc * (sc_original_wgt / sc_resample_wgt))",
        "+ ",
        "    #) %>%",
        "+ ",
        "    #select(-sc_original_weight, -sc_resample_weight)  # Drop extra columns",
        "+ ",
        "  ",
        "+ ",
        "  # Step 9: Create a survey design object for the ith sample",
        "+ ",
        "  resample_design <- resample %>%",
        "+ ",
        "    filter(!is.na(wgt_total_16sc)) %>%",
        "+ ",
        "    as_survey_design(weights = wgt_total_16sc, strata = wgt_geosc_16sc)",
        "+ ",
        "  ",
        "+ ",
        "  # Step 10a: Estimate the age- and sex-specific anxiety prevalence for the ith sample",
        "+ ",
        "  result_a <- resample_design %>%",
        "+ ",
        "    group_by(basis_udat_y_tri, basis_sex, basis_ageclass) %>%",
        "+ ",
        "    summarise(prev_a = survey_mean(a_emo_gad7_cut10, vartype = \"ci\", na.rm = TRUE)) %>%",
        "+ ",
        "    mutate(iteration = i)  # Add iteration number to the result",
        "+ ",
        "  ",
        "+ ",
        "  # Step 10b: Estimate the age- and sex-specific depression prevalence for the ith sample",
        "+ ",
        "  result_d <- resample_design %>%",
        "+ ",
        "    group_by(basis_udat_y_tri, basis_sex, basis_ageclass) %>%",
        "+ ",
        "    summarise(prev_d = survey_mean(a_emo_phq9_cut10, vartype = \"ci\", na.rm = TRUE)) %>%",
        "+ ",
        "    mutate(iteration = i)  # Add iteration number to the result",
        "+ ",
        "  ",
        "+ ",
        "  # Store the result for the current iteration",
        "+ ",
        "  resample_results_a[[i]] <- result_a",
        "+ ",
        "  resample_results_d[[i]] <- result_d",
        "+ ",
        "}",
        "> ",
        "# Step 11: Combine all the results into one dataframe",
        "> ",
        "merged_results_a <- bind_rows(resample_results_a) # anxiety",
        "> ",
        "merged_results_d <- bind_rows(resample_results_d) # depression",
        "> ",
        "merged_results_a %>% ",
        "+ ",
        "  group_by(iteration, wgt_geosc_16sc) %>% ",
        "+ ",
        "  summarise(sc_final_wgt = sum(wgt_total_16sc, na.rm = TRUE))",
        "\u001B[1m\u001B[33mError\u001B[39m in `group_by()`:\u001B[22m\n\u001B[38;5;252m\u001B[33m!\u001B[38;5;252m Must group by variables found in `.data`.\n\u001B[31m✖\u001B[38;5;252m Column `wgt_geosc_16sc` is not found.\u001B[39m\n\u001B[90mRun `\u001B]8;;x-r-run:rlang::last_trace()\u0007rlang::last_trace()\u001B]8;;\u0007` to see where the error occurred.\u001B[39m\n",
        "> ",
        "heaad(merged_results_a)",
        "Error in heaad(merged_results_a) : could not find function \"heaad\"\n",
        "> ",
        "View(merged_results_a)",
        "> ",
        "View(resample_results_a)",
        "> ",
        "View(merged_results_a)",
        "> ",
        "?rapply()",
        "> ",
        "X <- list(list(a = pi, b = list(c = 1L)), d = \"a test\")",
        "> ",
        "> ",
        "X[[1]]",
        "$a\n[1] 3.141593\n\n$b\n$b$c\n[1] 1\n\n\n",
        "> ",
        "X[1]",
        "[[1]]\n[[1]]$a\n[1] 3.141593\n\n[[1]]$b\n[[1]]$b$c\n[1] 1\n\n\n\n",
        "> ",
        "rapply(X, sqrt, classes = \"numeric\", how = \"replace\")",
        "[[1]]\n[[1]]$a\n[1] 1.772454\n\n[[1]]$b\n[[1]]$b$c\n[1] 1\n\n\n\n$d\n[1] \"a test\"\n\n\nRestarting R session...\n\n",
        "> ",
        "rm(list = ls())",
        "> ",
        "expit <- function(x){y<-exp(x); y/(1+y)}",
        "> ",
        "logit <- function(x){log(x/(1-x))}",
        "> ",
        "# approximated log of generalized mortality rate of German women in 2020",
        "> ",
        "fct_logm <- splinefun(x =     c(  .5,  1.5,   15,    25,    60,    80,  95, 100), ",
        "+ ",
        "                      y = log(c(3e-3, 1e-3, 9e-5, 19e-5, 45e-4, 35e-3, .28, .42)), ",
        "+ ",
        "                      method = \"natural\")",
        "> ",
        "# prevalence data (cross-sections for two years)",
        "> ",
        "p.data <- 1e-3*c(4.1, 16.4, 24.6, 22.7, 11.2,  1.5,  0.2,  0.01, # year 1: t = 10",
        "+ ",
        "                 6.2, 21.4, 28.9, 27.2, 15.3,  2.5,  0.1,  0.02) # year 2: t = 20",
        "> ",
        "p.ages <- c(15+10*(0:7))",
        "> ",
        "p.df   <- data.frame(p = p.data, t = rep(c(10, 20), each = length(p.ages)), a = rep(p.ages, 2))",
        "> ",
        "# model fit",
        "> ",
        "mod.p  <- lm(logit(p) ~ poly(a,3) + t, data = p.df)",
        "> ",
        "fct_p <- function(t, a){",
        "+ ",
        "   return(expit(predict.lm(mod.p, newdata = data.frame(t = rep(t, length(a)), a = a))))",
        "+ ",
        "}",
        "> ",
        "fct_dp <- function(t, a){",
        "+ ",
        "  return((fct_p(t+.001, a+.001) - fct_p(t-.001, a-.001))/.002)",
        "+ ",
        "}",
        "> ",
        "#png(\"Prev.png\", width = 2000, height = 1500, res = 200, pointsize = 24)",
        "> ",
        "matplot(.5 + 0:90, 1e3*fct_p(5, .5+0:90), type = \"l\", col = \"red\", las = 1, ",
        "+ ",
        "    ylab = \"Prevalence (per 1000)\", xlab = \"Age (years)\")",
        "> ",
        "matplot(.5 + 0:90, 1e3*fct_p(0, .5+0:90), type = \"l\", add = TRUE, lty = 2, lwd = 2)",
        "> ",
        "legend(\"topleft\", legend = c(\"Year 5\", \"Year 0\"), lwd = c(1, 2), ",
        "+ ",
        "  col = c(\"red\", \"black\"), lty = c(1,2), bty = \"n\")",
        "> ",
        "#png(\"PrevDerivPrev.png\", width = 3000, height = 1500, res = 200, pointsize = 24)",
        "> ",
        "par(mfrow = c(1, 2), las = 1)",
        "> ",
        "matplot(.5 + 0:90, 1e3*fct_p(2.5, .5+0:90), type = \"l\", col = \"red\", ",
        "+ ",
        "    ylab = expression(paste(\"Prevalence \", italic(p), \" (per 1000)\")), xlab = \"Age (years)\")",
        "> ",
        "matplot(.5 + 0:90, 1e3*fct_p(2.5, .5+0:90), type = \"l\", col = \"black\", lty = 2, add = TRUE) ",
        "> ",
        "matplot(.5 + 0:90, 1e4*fct_dp(2.5, .5+0:90), type = \"l\", col = \"blue\", ",
        "+ ",
        "las = 1, ylab = expression(paste(\"Derivative \", partialdiff, italic(p), \" (per 10,000)\")), xlab = \"Age (years)\")",
        "> ",
        "fct_i <- function(beta1 = 15e-4, beta2 = 25, beta3 = 10){",
        "+ ",
        "  return(beta1*exp(-0.5*((age-beta2)/beta3)^2))",
        "+ ",
        "}",
        "> ",
        "fct_r <- function(beta1 = 5e-5, beta2 = 55, beta3 = 5){",
        "+ ",
        "  return(beta1*exp(-0.5*((age-beta2)/beta3)^2))",
        "+ ",
        "}",
        "> ",
        "# mortality rate ratio from Danish ICD register (see shiny)",
        "> ",
        "fct_R <- function(a){ return(exp(approx(c(7.5, 50), c(log(10), 0), xout = a, rule = 2)$y)) }",
        "> ",
        "age <- .5+0:90",
        "> ",
        "MRR <- fct_R(age)",
        "> ",
        "dp_ <- fct_dp(2.5, age)",
        "> ",
        "p_  <- fct_p (2.5, age)",
        "> ",
        "m_  <- exp(fct_logm(age))",
        "> ",
        "fct_target <- function(x){",
        "+ ",
        "  rhs_ <- (1-p_)*(fct_i(x[1],x[2],x[3]) - m_*p_*(MRR-1)/(1+p_*(MRR-1))) - fct_r(x[4],x[5],x[6])*p_",
        "+ ",
        "  return(sum( (dp_ - (rhs_))^2))",
        "+ ",
        "}",
        "> ",
        "x0 <- c(0.0002,30,10,0.0002,55,10)",
        "> ",
        "optim_res <- optim(x0, fct_target, control = list(maxit = 5000),",
        "+ ",
        "               hessian = TRUE)",
        "> ",
        "optim_res$par",
        "[1]  0.001758939 27.049942614  9.208655668  0.152645663 65.679528631 13.774756599\n\nRestarting R session...\n\n"
    ]
}